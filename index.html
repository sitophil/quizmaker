<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مبدل آزمون ریسپانسیو و مدرن</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playpen+Sans+Arabic:wght@100..800&display=swap');
        :root { --primary: #6c5ce7; --bg: #f0f3f7; }
        body { font-family: 'Playpen Sans Arabic', cursive; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .converter-card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; max-width: 450px; width: 100%; }
        h2 { color: var(--primary); margin-bottom: 25px; }
        .file-upload { border: 2px dashed #cbd5e0; padding: 25px; border-radius: 15px; margin-bottom: 20px; position: relative; transition: 0.3s; }
        .file-upload:hover { border-color: var(--primary); background: #f8faff; }
        input[type="file"] { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
        .btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-family: 'Playpen Sans Arabic', cursive; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; }
    </style>
</head>
<body>

<div class="converter-card">
    <h2>سازنده آزمون ریسپانسیو</h2>
    <div class="file-upload">
        <span id="fileName">فایل CSV را اینجا رها کنید</span>
        <input type="file" id="csvFile" accept=".csv" onchange="document.getElementById('fileName').innerText = this.files[0].name">
    </div>
    <button class="btn" onclick="processFile()">تولید و دانلود نسخه موبایل-فرندلی</button>
</div>

<script>
function processFile() {
    const fileInput = document.getElementById('csvFile');
    if (!fileInput.files[0]) return alert("فایل انتخاب نشده است!");

    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const questions = text.split('\n').filter(r => r.trim() !== '').map(row => {
            const c = row.split(',').map(s => s.trim());
            return { q: c[0], options: [c[1], c[2], c[3], c[4]], ans: parseInt(c[5]) };
        });
        generateHTML(questions);
    };
    reader.readAsText(fileInput.files[0]);
}

function generateHTML(data) {
    const template = `
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آزمون آنلاین ریسپانسیو</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playpen+Sans+Arabic:wght@100..800&display=swap');
        :root { --p: #6c5ce7; --bg: #f8f9fd; }
        body { font-family: 'Playpen Sans Arabic', cursive; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .quiz-card { background: white; width: 100%; max-width: 600px; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-top: 20px; position: relative; overflow: hidden; }
        .progress-bar { position: absolute; top: 0; left: 0; height: 5px; background: var(--p); transition: 0.4s; }
        .q-text { font-size: 1.2rem; font-weight: bold; margin: 20px 0; line-height: 1.6; }
        .opt { display: flex; align-items: center; padding: 14px; border: 2px solid #edf2f7; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .opt:hover { background: #f4f2ff; border-color: var(--p); }
        .opt.selected { background: var(--p); color: white; border-color: var(--p); }
        .nav-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 25px; }
        .n-btn { background: var(--p); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-family: 'Playpen Sans Arabic', cursive; font-size: 1rem; }
        .n-btn:disabled { background: #e2e8f0; color: #a0aec0; cursor: not-allowed; }
        #result-screen { display: none; text-align: center; }
        .chart-container { width: 100%; max-width: 250px; margin: 0 auto; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .stat-box { padding: 15px; border-radius: 12px; background: #f7fafc; border: 1px solid #edf2f7; }
        .result-item { padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #edf2f7; }
        .correct-bg { background: #f0fff4; border-color: #c6f6d5; }
        .incorrect-bg { background: #fff5f5; border-color: #fed7d7; }
        .result-opt { padding: 8px; border-radius: 8px; margin: 5px 0; font-size: 0.9rem; }
        .correct-opt { background: #38a169; color: white; font-weight: bold; }
        .incorrect-opt { background: #e53e3e; color: white; }
        
        /* Media Queries برای موبایل‌های خیلی کوچک */
        @media (max-width: 400px) {
            .q-text { font-size: 1.1rem; }
            .quiz-card { padding: 15px; }
            .opt { padding: 12px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="quiz-card">
        <div class="progress-bar" id="pb"></div>
        <div id="quiz-screen">
            <div id="q-number" style="color: #718096; font-size: 0.85rem;"></div>
            <div class="q-text" id="q-content"></div>
            <div id="options-container"></div>
            <div class="nav-btns">
                <button class="n-btn" id="prevBtn" onclick="prevQ()">قبلی</button>
                <button class="n-btn" id="nextBtn" onclick="nextQ()">بعدی</button>
            </div>
        </div>

        <div id="result-screen">
            <h2 style="margin-bottom: 10px;">پایان آزمون</h2>
            <div class="chart-container"><canvas id="myChart"></canvas></div>
            <div class="stat-grid">
                <div class="stat-box">صحیح: <b id="c-count" style="color:#38a169"></b></div>
                <div class="stat-box">غلط: <b id="w-count" style="color:#e53e3e"></b></div>
            </div>
            <div id="detailed-results" style="margin-top: 25px; text-align: right;"></div>
            <button class="n-btn" style="margin-top:20px; width:100%" onclick="location.reload()">تکرار آزمون</button>
        </div>
    </div>

    <script>
        const quizData = ${JSON.stringify(data)};
        let currentIdx = 0;
        let userAnswers = new Array(quizData.length).fill(null);

        function showQuestion() {
            const q = quizData[currentIdx];
            document.getElementById('q-number').innerText = 'سوال ' + (currentIdx + 1) + ' از ' + quizData.length;
            document.getElementById('q-content').innerText = q.q;
            document.getElementById('pb').style.width = ((currentIdx + 1) / quizData.length * 100) + '%';
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            q.options.forEach((opt, i) => {
                const div = document.createElement('div');
                div.className = 'opt' + (userAnswers[currentIdx] === i + 1 ? ' selected' : '');
                div.innerText = (i + 1) + '. ' + opt;
                div.onclick = () => { userAnswers[currentIdx] = i + 1; showQuestion(); };
                container.appendChild(div);
            });

            document.getElementById('prevBtn').disabled = currentIdx === 0;
            document.getElementById('nextBtn').innerText = currentIdx === quizData.length - 1 ? 'ثبت و پایان' : 'سوال بعدی';
        }

        function nextQ() {
            if (currentIdx < quizData.length - 1) { currentIdx++; showQuestion(); }
            else showResults();
        }

        function prevQ() { if (currentIdx > 0) { currentIdx--; showQuestion(); } }

        function showResults() {
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';
            let correct = userAnswers.reduce((acc, ans, i) => acc + (ans === quizData[i].ans ? 1 : 0), 0);
            document.getElementById('c-count').innerText = correct;
            document.getElementById('w-count').innerText = quizData.length - correct;

            new Chart(document.getElementById('myChart'), {
                type: 'doughnut',
                data: {
                    labels: ['صحیح', 'غلط'],
                    datasets: [{ data: [correct, quizData.length - correct], backgroundColor: ['#38a169', '#e53e3e'], borderWeight: 0 }]
                },
                options: { cutout: '70%', plugins: { legend: { display: false } } }
            });

            const detailedContainer = document.getElementById('detailed-results');
            detailedContainer.innerHTML = '<h3 style="margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">بررسی سوالات:</h3>';

            quizData.forEach((q, i) => {
                const userAns = userAnswers[i];
                const isCorrect = userAns === q.ans;
                const item = document.createElement('div');
                item.className = 'result-item ' + (isCorrect ? 'correct-bg' : 'incorrect-bg');

                let optionsHtml = '';
                q.options.forEach((opt, idx) => {
                    const optNum = idx + 1;
                    let optClass = 'result-opt';
                    if (optNum === q.ans) optClass += ' correct-opt';
                    else if (optNum === userAns) optClass += ' incorrect-opt';

                    optionsHtml += \`<div class="\${optClass}">\${optNum}. \${opt} \${optNum === userAns ? ' (پاسخ شما)' : ''} \${optNum === q.ans ? ' (پاسخ صحیح)' : ''}<\/div>\`;
                });

                item.innerHTML = \`
                    <div style="font-weight: bold; margin-bottom: 10px;">سوال \${i + 1}: \${q.q}<\/div>
                    <div class="result-options">\${optionsHtml}<\/div>
                \`;
                detailedContainer.appendChild(item);
            });
        }
        showQuestion();
    <\/script>
</body>
</html>`;

    const blob = new Blob([template], { type: 'text/html' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'modern_mobile_quiz.html';
    link.click();
}
</script>

</body>
</html>
